<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Tools - StockDigest Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #ffffff;
            padding: 24px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link {
            display: inline-block;
            color: #ffffff;
            text-decoration: none;
            margin-bottom: 12px;
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link:hover {
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1e40af;
        }

        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }

        .tab-content {
            background: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #1e40af;
        }

        button {
            background: #1e40af;
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1e3a8a;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .validation-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .validation-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .validation-result.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #1e40af;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/admin?token={{ token }}" class="back-link">‚Üê Back to Dashboard</a>
        <h1>üìë Research Tools</h1>
        <p>Generate AI summaries of earnings transcripts, press releases, and company profiles</p>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('transcripts', event)">Earnings Transcripts</button>
            <button class="tab" onclick="switchTab('press-releases', event)">Press Releases</button>
            <button class="tab" onclick="switchTab('company-profiles', event)">Company Profiles</button>
            <button class="tab" onclick="switchTab('view-profiles', event)">View Profiles</button>
        </div>

        <!-- Earnings Transcripts Tab -->
        <div id="transcripts-tab" class="tab-content">
            <h2>Generate Earnings Transcript Summary</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Fetch earnings call transcripts from FMP and generate AI summaries using Claude.
            </p>

            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="transcript-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForTranscript()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="transcript-validation-result"></div>

            <div id="transcript-quarter-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Select Quarter <span style="color: #dc2626;">*</span></label>
                    <select id="transcript-quarter">
                        <option value="">Validate ticker first...</option>
                    </select>
                </div>

                <button onclick="generateTranscriptSummary()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Summary (30-60 sec)
                </button>
            </div>

            <div id="transcript-result" style="display:none; margin-top: 24px; padding: 16px;
                                              background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Transcript summary generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full summary. The summary has been saved to the database.
                </p>
            </div>

            <div id="transcript-error" style="display:none; margin-top: 24px; padding: 16px;
                                             background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Summary generation failed
                </p>
                <p id="transcript-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>

        <!-- Press Releases Tab -->
        <div id="press-releases-tab" class="tab-content" style="display:none;">
            <h2>Generate Press Release Summary</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Fetch press releases from FMP and generate AI summaries using Claude.
            </p>

            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="pr-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForPR()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="pr-validation-result"></div>

            <div id="pr-release-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Select Press Release <span style="color: #dc2626;">*</span></label>
                    <select id="pr-release">
                        <option value="">Validate ticker first...</option>
                    </select>
                </div>

                <button onclick="generatePRSummary()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Summary (30-60 sec)
                </button>
            </div>

            <div id="pr-result" style="display:none; margin-top: 24px; padding: 16px;
                                      background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Press release summary generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full summary. The summary has been saved to the database.
                </p>
            </div>

            <div id="pr-error" style="display:none; margin-top: 24px; padding: 16px;
                                     background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Summary generation failed
                </p>
                <p id="pr-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>

        <!-- Company Profiles Tab -->
        <div id="company-profiles-tab" class="tab-content" style="display:none;">
            <h2>Generate Company Profile</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Upload a 10-K PDF or TXT file to generate a comprehensive company profile using Gemini 2.5 Flash AI.
                Processing takes 5-10 minutes.
            </p>

            <!-- Step 1: Ticker Input -->
            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="profile-ticker" placeholder="e.g., TSLA, AAPL, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForProfile()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="profile-validation-result"></div>

            <!-- Step 2: Year Selection (shown after validation) -->
            <div id="profile-year-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Select Fiscal Year <span style="color: #dc2626;">*</span></label>
                    <select id="profile-fiscal-year" style="width: 100%;">
                        <option value="">Validate ticker first...</option>
                    </select>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        Select the fiscal year from available SEC filings
                    </p>
                </div>

                <button onclick="generateCompanyProfile()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Profile (5-10 min)
                </button>
            </div>

            <!-- Step 3: Job Status (shown during processing) -->
            <div id="profile-job-status" style="display:none; margin-top: 32px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Processing...</h3>

                <div style="background: #f3f4f6; border-radius: 8px; overflow: hidden; height: 40px; position: relative;">
                    <div id="profile-progress"
                         style="width: 0%; height: 100%; background: linear-gradient(90deg, #1e3a8a, #1e40af);
                                transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <span id="profile-progress-text" style="color: white; font-weight: 600; font-size: 14px;
                                                                position: absolute; left: 50%; transform: translateX(-50%);">
                            0%
                        </span>
                    </div>
                </div>

                <p id="profile-status-text" style="margin-top: 12px; font-size: 14px; color: #4b5563;">
                    Extracting 10-K text...
                </p>

                <p id="profile-time-estimate" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    Estimated time: 5-10 minutes
                </p>
            </div>

            <!-- Step 4: Result Display -->
            <div id="profile-result" style="display:none; margin-top: 24px; padding: 16px;
                                            background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Company profile generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full profile. The profile has been saved to the database.
                </p>
            </div>

            <div id="profile-error" style="display:none; margin-top: 24px; padding: 16px;
                                           background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Profile generation failed
                </p>
                <p id="profile-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>

        <!-- View Profiles Tab -->
        <div id="view-profiles-tab" class="tab-content" style="display:none;">
            <h2>Company Profiles Library</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Browse, search, and manage all generated company profiles.
            </p>

            <!-- Search Box -->
            <div style="margin-bottom: 20px;">
                <input
                    type="text"
                    id="profiles-search"
                    placeholder="üîç Search by ticker or company name..."
                    oninput="filterProfiles()"
                    style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                    onfocus="this.style.borderColor='#1e40af'"
                    onblur="this.style.borderColor='#e5e7eb'"
                />
            </div>

            <div id="profiles-loading" style="text-align: center; padding: 40px;">
                <p style="color: #6b7280;">Loading profiles...</p>
            </div>

            <div id="profiles-list" style="display:none;">
                <p id="profiles-count" style="margin-bottom: 16px; color: #6b7280; font-size: 14px;"></p>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; min-width: 1200px;">
                        <thead style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white;">
                            <tr>
                                <th onclick="sortTable('ticker')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;">
                                    Ticker <span id="sort-ticker" style="font-size: 10px;">‚ñº</span>
                                </th>
                                <th onclick="sortTable('company_name')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;">
                                    Company <span id="sort-company_name" style="font-size: 10px;">‚óã</span>
                                </th>
                                <th onclick="sortTable('industry')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;">
                                    Industry <span id="sort-industry" style="font-size: 10px;">‚óã</span>
                                </th>
                                <th onclick="sortTable('fiscal_year')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;">
                                    FY <span id="sort-fiscal_year" style="font-size: 10px;">‚óã</span>
                                </th>
                                <th onclick="sortTable('generated_at')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;">
                                    Generated <span id="sort-generated_at" style="font-size: 10px;">‚óã</span>
                                </th>
                                <th style="padding: 12px; text-align: center;">Tokens (In/Out)</th>
                                <th style="padding: 12px; text-align: center;">Time</th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="profiles-table-body">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="profiles-error" style="display:none; padding: 20px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px; margin-top: 20px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b;">Error loading profiles</p>
                <p id="profiles-error-message" style="margin: 8px 0 0 0; color: #991b1b; font-size: 14px;"></p>
            </div>
        </div>

        <!-- Profile Viewer Modal -->
        <div id="profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
            <div style="background: white; margin: 40px auto; max-width: 1000px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;">
                <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                    <h2 id="modal-title" style="margin: 0; color: #1e3a8a;">Company Profile</h2>
                    <button onclick="closeProfileModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                </div>

                <div id="modal-content" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- Profile markdown will be rendered here -->
                </div>

                <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="downloadProfile()" style="background: #1e40af; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Download Markdown
                    </button>
                    <button onclick="closeProfileModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>StockDigest Research Tools | <a href="mailto:stockdigest.research@gmail.com" style="color: #1e40af;">Contact Support</a></p>
    </div>

    <script>
        const token = '{{ token }}';

        // =============================================================================
        // TAB SWITCHING
        // =============================================================================

        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // =============================================================================
        // EARNINGS TRANSCRIPTS TAB
        // =============================================================================

        async function validateTickerForTranscript() {
            const ticker = document.getElementById('transcript-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('transcript-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=transcript`);
                const data = await response.json();

                if (data.valid) {
                    const select = document.getElementById('transcript-quarter');
                    select.innerHTML = '';

                    if (data.available_quarters && data.available_quarters.length > 0) {
                        data.available_quarters.forEach((q, index) => {
                            const option = document.createElement('option');
                            option.value = q;
                            option.textContent = q + (index === 0 ? ' (Latest)' : '');
                            if (index === 0) option.selected = true;
                            select.appendChild(option);
                        });

                        resultDiv.innerHTML = `
                            <div class="validation-result success">
                                ‚úÖ ${ticker} - ${data.company_name}<br>
                                <span style="font-size: 12px; color: #059669;">${data.available_quarters.length} transcripts available</span>
                            </div>
                        `;

                        document.getElementById('transcript-quarter-section').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `<div class="validation-result error">‚ùå No transcripts available for ${ticker}</div>`;
                        document.getElementById('transcript-quarter-section').style.display = 'none';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('transcript-quarter-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generateTranscriptSummary() {
            const ticker = document.getElementById('transcript-ticker').value.toUpperCase().trim();
            const quarterStr = document.getElementById('transcript-quarter').value;

            if (!ticker || !quarterStr) {
                alert('Please validate ticker and select a quarter first');
                return;
            }

            // Parse "Q3 2024" into quarter=3, year=2024
            const match = quarterStr.match(/Q(\d+)\s+(\d{4})/);
            if (!match) {
                alert('Invalid quarter format');
                return;
            }

            const quarter = parseInt(match[1]);
            const year = parseInt(match[2]);

            // Hide sections, show processing
            document.getElementById('transcript-quarter-section').style.display = 'none';
            document.getElementById('transcript-result').style.display = 'none';
            document.getElementById('transcript-error').style.display = 'none';

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'transcript',
                        quarter: quarter,
                        year: year
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('transcript-result').style.display = 'block';
                } else {
                    document.getElementById('transcript-error').style.display = 'block';
                    document.getElementById('transcript-error-message').textContent = result.message;
                    document.getElementById('transcript-quarter-section').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('transcript-error').style.display = 'block';
                document.getElementById('transcript-error-message').textContent = error.message;
                document.getElementById('transcript-quarter-section').style.display = 'block';
            }
        }

        // =============================================================================
        // PRESS RELEASES TAB
        // =============================================================================

        async function validateTickerForPR() {
            const ticker = document.getElementById('pr-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('pr-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=press_release`);
                const data = await response.json();

                if (data.valid) {
                    const select = document.getElementById('pr-release');
                    select.innerHTML = '';

                    if (data.available_releases && data.available_releases.length > 0) {
                        data.available_releases.forEach((r, index) => {
                            const option = document.createElement('option');
                            option.value = r.date;
                            option.textContent = `${r.date} - ${r.title}`;
                            if (index === 0) option.selected = true;
                            select.appendChild(option);
                        });

                        resultDiv.innerHTML = `
                            <div class="validation-result success">
                                ‚úÖ ${ticker} - ${data.company_name}<br>
                                <span style="font-size: 12px; color: #059669;">${data.available_releases.length} press releases available</span>
                            </div>
                        `;

                        document.getElementById('pr-release-section').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `<div class="validation-result error">‚ùå No press releases available for ${ticker}</div>`;
                        document.getElementById('pr-release-section').style.display = 'none';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('pr-release-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generatePRSummary() {
            const ticker = document.getElementById('pr-ticker').value.toUpperCase().trim();
            const prDate = document.getElementById('pr-release').value;

            if (!ticker || !prDate) {
                alert('Please validate ticker and select a press release first');
                return;
            }

            // Hide sections, show processing
            document.getElementById('pr-release-section').style.display = 'none';
            document.getElementById('pr-result').style.display = 'none';
            document.getElementById('pr-error').style.display = 'none';

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'press_release',
                        pr_date: prDate
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('pr-result').style.display = 'block';
                } else {
                    document.getElementById('pr-error').style.display = 'block';
                    document.getElementById('pr-error-message').textContent = result.message;
                    document.getElementById('pr-release-section').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('pr-error').style.display = 'block';
                document.getElementById('pr-error-message').textContent = error.message;
                document.getElementById('pr-release-section').style.display = 'block';
            }
        }

        // =============================================================================
        // COMPANY PROFILES TAB
        // =============================================================================

        async function validateTickerForProfile() {
            const ticker = document.getElementById('profile-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('profile-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=profile`);
                const data = await response.json();

                if (data.valid) {
                    const select = document.getElementById('profile-fiscal-year');
                    select.innerHTML = '';

                    if (data.available_years && data.available_years.length > 0) {
                        // Populate dropdown with available years
                        data.available_years.forEach((y, index) => {
                            const option = document.createElement('option');
                            option.value = index;  // Store index to access data later
                            option.dataset.year = y.year;
                            option.dataset.filingDate = y.filing_date;
                            option.dataset.secHtmlUrl = y.sec_html_url;
                            option.textContent = `${y.year} (Filed: ${y.filing_date})`;
                            if (index === 0) option.selected = true;  // Select latest by default
                            select.appendChild(option);
                        });

                        resultDiv.innerHTML = `
                            <div class="validation-result success">
                                ‚úÖ ${ticker} - ${data.company_name} (${data.industry})<br>
                                <span style="font-size: 12px; color: #059669;">Found ${data.available_years.length} 10-K filings from FMP</span>
                            </div>
                        `;

                        // Show year selection section
                        document.getElementById('profile-year-section').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `
                            <div class="validation-result warning">
                                ‚ö†Ô∏è ${ticker} - ${data.company_name} (${data.industry})<br>
                                <span style="font-size: 12px; color: #92400e;">${data.message || 'No 10-K filings found in FMP'}</span>
                            </div>
                        `;
                        document.getElementById('profile-year-section').style.display = 'none';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('profile-year-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generateCompanyProfile() {
            const ticker = document.getElementById('profile-ticker').value.toUpperCase().trim();
            const select = document.getElementById('profile-fiscal-year');
            const selectedOption = select.options[select.selectedIndex];

            // Validation
            if (!ticker) {
                alert('Please enter and validate a ticker symbol first');
                return;
            }

            if (!selectedOption || !selectedOption.dataset.secHtmlUrl) {
                alert('Please select a fiscal year from the dropdown');
                return;
            }

            // Extract data from selected option
            const fiscalYear = parseInt(selectedOption.dataset.year);
            const filingDate = selectedOption.dataset.filingDate;
            const secHtmlUrl = selectedOption.dataset.secHtmlUrl;

            // Hide year section, show status
            document.getElementById('profile-year-section').style.display = 'none';
            document.getElementById('profile-job-status').style.display = 'block';
            document.getElementById('profile-result').style.display = 'none';
            document.getElementById('profile-error').style.display = 'none';

            try {
                // Create job (FMP mode - no file upload needed!)
                const response = await fetch('/api/admin/generate-company-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        fiscal_year: fiscalYear,
                        filing_date: filingDate,
                        sec_html_url: secHtmlUrl
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Start polling job status
                    pollCompanyProfileJobStatus(result.job_id);
                } else {
                    // Show error
                    document.getElementById('profile-job-status').style.display = 'none';
                    document.getElementById('profile-error').style.display = 'block';
                    document.getElementById('profile-error-message').textContent = result.message;
                    document.getElementById('profile-year-section').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('profile-job-status').style.display = 'none';
                document.getElementById('profile-error').style.display = 'block';
                document.getElementById('profile-error-message').textContent = error.message;
                document.getElementById('profile-year-section').style.display = 'block';
            }
        }

        async function pollCompanyProfileJobStatus(jobId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/jobs/${jobId}?token=${token}`);
                    const status = await response.json();

                    // Update progress bar
                    const progress = status.progress || 0;
                    document.getElementById('profile-progress').style.width = progress + '%';
                    document.getElementById('profile-progress-text').textContent = progress + '%';

                    // Update status text
                    const phaseMessages = {
                        'extracting_text': 'Extracting 10-K text...',
                        'generating_profile': 'Generating profile with Gemini 2.5 Flash (5-10 min)...',
                        'saving_profile': 'Saving profile to database...',
                        'sending_email': 'Sending email notification...',
                        'complete': 'Complete!'
                    };

                    document.getElementById('profile-status-text').textContent =
                        phaseMessages[status.phase] || status.phase || 'Processing...';

                    // Update time estimate
                    if (progress < 30) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: 8-10 minutes';
                    } else if (progress < 80) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: 3-5 minutes';
                    } else if (progress < 100) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: < 1 minute';
                    }

                    // Check completion
                    if (status.status === 'completed') {
                        clearInterval(pollInterval);

                        // Show success
                        document.getElementById('profile-job-status').style.display = 'none';
                        document.getElementById('profile-result').style.display = 'block';

                    } else if (status.status === 'failed' || status.status === 'timeout') {
                        clearInterval(pollInterval);

                        // Show error
                        document.getElementById('profile-job-status').style.display = 'none';
                        document.getElementById('profile-error').style.display = 'block';
                        document.getElementById('profile-error-message').textContent =
                            status.error_message || 'Unknown error occurred';
                        document.getElementById('profile-upload-section').style.display = 'block';
                    }

                } catch (error) {
                    clearInterval(pollInterval);

                    document.getElementById('profile-job-status').style.display = 'none';
                    document.getElementById('profile-error').style.display = 'block';
                    document.getElementById('profile-error-message').textContent =
                        'Failed to poll job status: ' + error.message;
                }

            }, 10000); // Poll every 10 seconds
        }

        // =============================================================================
        // VIEW PROFILES TAB
        // =============================================================================

        let currentProfile = null;  // Store current profile for download

        async function loadProfiles() {
            document.getElementById('profiles-loading').style.display = 'block';
            document.getElementById('profiles-list').style.display = 'none';
            document.getElementById('profiles-error').style.display = 'none';

            try {
                const response = await fetch(`/api/admin/company-profiles?token=${token}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayProfiles(data.profiles);
                } else {
                    document.getElementById('profiles-loading').style.display = 'none';
                    document.getElementById('profiles-error').style.display = 'block';
                    document.getElementById('profiles-error-message').textContent = data.message || 'Failed to load profiles';
                }
            } catch (error) {
                document.getElementById('profiles-loading').style.display = 'none';
                document.getElementById('profiles-error').style.display = 'block';
                document.getElementById('profiles-error-message').textContent = error.message;
            }
        }

        let allProfiles = [];  // Store all profiles for filtering/sorting
        let currentSort = { column: 'ticker', direction: 'asc' };

        function displayProfiles(profiles) {
            allProfiles = profiles;  // Store for filtering/sorting
            document.getElementById('profiles-loading').style.display = 'none';
            document.getElementById('profiles-list').style.display = 'block';
            document.getElementById('profiles-count').textContent = `Found ${profiles.length} company profile(s)`;

            const tbody = document.getElementById('profiles-table-body');
            tbody.innerHTML = '';

            if (profiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #6b7280;">No profiles generated yet. Create one in the "Company Profiles" tab!</td></tr>';
                return;
            }

            profiles.forEach(profile => {
                const row = document.createElement('tr');
                row.setAttribute('data-ticker', profile.ticker);
                row.setAttribute('data-company', profile.company_name.toLowerCase());
                row.style.borderBottom = '1px solid #e5e7eb';
                row.onmouseover = () => row.style.background = '#f9fafb';
                row.onmouseout = () => row.style.background = 'white';

                const generatedDate = new Date(profile.generated_at).toLocaleString();
                const tokensIn = (profile.token_count_input || 0).toLocaleString();
                const tokensOut = (profile.token_count_output || 0).toLocaleString();
                const genTime = profile.generation_time_seconds || 0;
                const timeStr = genTime >= 60 ? `${Math.floor(genTime/60)}m ${genTime%60}s` : `${genTime}s`;

                row.innerHTML = `
                    <td style="padding: 12px; font-weight: 600; color: #1e40af;">${profile.ticker}</td>
                    <td style="padding: 12px;">${profile.company_name}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 13px;">${profile.industry || 'N/A'}</td>
                    <td style="padding: 12px;">${profile.fiscal_year}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 13px;">${generatedDate}</td>
                    <td style="padding: 12px; text-align: center; color: #6b7280; font-size: 12px;">
                        <div>${tokensIn} / ${tokensOut}</div>
                        <div style="font-size: 11px; color: #9ca3af;">(${((profile.token_count_input || 0) + (profile.token_count_output || 0)).toLocaleString()} total)</div>
                    </td>
                    <td style="padding: 12px; text-align: center; color: #6b7280; font-size: 13px;">${timeStr}</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="viewProfile('${profile.ticker}'); event.stopPropagation();"
                                    title="View Profile"
                                    style="background: #1e40af; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üëÅÔ∏è
                            </button>
                            <button onclick="emailProfile('${profile.ticker}'); event.stopPropagation();"
                                    title="Email to Me"
                                    style="background: #059669; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üìß
                            </button>
                            <button onclick="deleteProfile('${profile.ticker}', '${profile.company_name}'); event.stopPropagation();"
                                    title="Delete Profile"
                                    style="background: #dc2626; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        async function viewProfile(ticker) {
            try {
                const response = await fetch(`/api/admin/company-profiles?token=${token}`);
                const data = await response.json();

                if (data.status === 'success') {
                    const profile = data.profiles.find(p => p.ticker === ticker);
                    if (profile) {
                        currentProfile = profile;
                        document.getElementById('modal-title').textContent = `${profile.company_name} (${profile.ticker}) - FY${profile.fiscal_year}`;
                        document.getElementById('modal-content').innerHTML = markdownToHtml(profile.profile_markdown);
                        document.getElementById('profile-modal').style.display = 'block';
                    }
                }
            } catch (error) {
                alert('Failed to load profile: ' + error.message);
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
            currentProfile = null;
        }

        function downloadProfile() {
            if (!currentProfile) return;

            const filename = `${currentProfile.ticker}_CompanyProfile_FY${currentProfile.fiscal_year}.md`;
            const blob = new Blob([currentProfile.profile_markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Filter profiles by search query
        function filterProfiles() {
            const searchQuery = document.getElementById('profiles-search').value.toLowerCase();
            const rows = document.querySelectorAll('#profiles-table-body tr');

            let visibleCount = 0;
            rows.forEach(row => {
                const ticker = row.getAttribute('data-ticker') || '';
                const company = row.getAttribute('data-company') || '';

                if (ticker.toLowerCase().includes(searchQuery) || company.includes(searchQuery)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            const countText = searchQuery ?
                `Showing ${visibleCount} of ${allProfiles.length} profile(s)` :
                `Found ${allProfiles.length} company profile(s)`;
            document.getElementById('profiles-count').textContent = countText;
        }

        // Sort table by column
        function sortTable(column) {
            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update sort indicators
            document.querySelectorAll('[id^="sort-"]').forEach(el => {
                el.textContent = '‚óã';
            });
            document.getElementById(`sort-${column}`).textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';

            // Sort profiles array
            const sorted = [...allProfiles].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle nulls
                if (!aVal) return 1;
                if (!bVal) return -1;

                // String comparison
                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ?
                        aVal.localeCompare(bVal) :
                        bVal.localeCompare(aVal);
                }

                // Number comparison
                return currentSort.direction === 'asc' ?
                    aVal - bVal :
                    bVal - aVal;
            });

            // Re-display sorted profiles
            displayProfiles(sorted);

            // Re-apply current search filter
            const searchQuery = document.getElementById('profiles-search').value;
            if (searchQuery) {
                filterProfiles();
            }
        }

        // Delete profile
        async function deleteProfile(ticker, companyName) {
            if (!confirm(`Are you sure you want to delete the profile for ${companyName} (${ticker})?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/delete-company-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, ticker })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                    // Reload profiles
                    loadProfiles();
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to delete profile: ${error.message}`);
            }
        }

        // Email profile to admin
        async function emailProfile(ticker) {
            if (!confirm(`Send the profile for ${ticker} to your email?`)) {
                return;
            }

            // Show loading indicator
            const originalText = event.target.textContent;
            event.target.textContent = '‚è≥';
            event.target.disabled = true;

            try {
                const response = await fetch('/api/admin/email-company-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, ticker })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to email profile: ${error.message}`);
            } finally {
                event.target.textContent = originalText;
                event.target.disabled = false;
            }
        }

        // Simple markdown to HTML converter
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Headers
            html = html.replace(/^# (.*$)/gim, '<h1 style="margin-top: 24px; margin-bottom: 12px; color: #1e3a8a; font-size: 28px;">$1</h1>');
            html = html.replace(/^## (.*$)/gim, '<h2 style="margin-top: 20px; margin-bottom: 10px; color: #1e40af; font-size: 22px;">$1</h2>');
            html = html.replace(/^### (.*$)/gim, '<h3 style="margin-top: 16px; margin-bottom: 8px; color: #2563eb; font-size: 18px;">$1</h3>');

            // Bold and italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Lists
            html = html.replace(/^\* (.*$)/gim, '<li style="margin-left: 20px; margin-bottom: 6px;">$1</li>');
            html = html.replace(/(<li.*<\/li>)/s, '<ul style="margin: 12px 0;">$1</ul>');

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p style="margin-bottom: 12px; line-height: 1.6;">');
            html = '<p style="margin-bottom: 12px; line-height: 1.6;">' + html + '</p>';

            return html;
        }

        // Enhanced switchTab to load profiles when View Profiles tab is opened
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName, event) {
            if (originalSwitchTab) {
                originalSwitchTab(tabName, event);
            } else {
                // Fallback if original doesn't exist
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabName + '-tab').style.display = 'block';
                if (event) event.target.classList.add('active');
            }

            // Load profiles when View Profiles tab is opened
            if (tabName === 'view-profiles') {
                loadProfiles();
            }
        };

        // Close modal on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProfileModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('profile-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });
    </script>
</body>
</html>
