<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Tools - StockDigest Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #ffffff;
            padding: 24px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link {
            display: inline-block;
            color: #ffffff;
            text-decoration: none;
            margin-bottom: 12px;
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link:hover {
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1e40af;
        }

        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }

        .tab-content {
            background: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #1e40af;
        }

        button {
            background: #1e40af;
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1e3a8a;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .validation-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .validation-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .validation-result.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #1e40af;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/admin?token={{ token }}" class="back-link">‚Üê Back to Dashboard</a>
        <h1>üìë Research Tools</h1>
        <p>Generate AI summaries of earnings transcripts, press releases, and company profiles</p>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('generate-research', event)">Generate Research</button>
            <button class="tab" onclick="switchTab('research-library', event)">Research Library</button>
        </div>

        <!-- Generate Research Tab (Unified) -->
        <div id="generate-research-tab" class="tab-content">
            <h2>Generate Research</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Enter a ticker to see all available research and generate comprehensive AI analyses.
            </p>

            <!-- Ticker Input -->
            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="unified-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="loadTickerResearch()" style="margin-top: 8px;">Load Research Options</button>
            </div>

            <!-- Loading State -->
            <div id="research-loading" style="display:none; text-align: center; padding: 40px;">
                <div class="loading"></div>
                <p style="color: #6b7280; margin-top: 12px;">Loading available research...</p>
            </div>

            <!-- Error State -->
            <div id="research-error" style="display:none; margin-top: 20px; padding: 16px;
                                            background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b;">Error</p>
                <p id="research-error-message" style="margin: 8px 0 0 0; color: #991b1b; font-size: 14px;"></p>
            </div>

            <!-- Research Sections Container -->
            <div id="research-sections" style="display:none; margin-top: 32px;">
                <!-- Company Info Header -->
                <div id="company-header" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                                                 color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 id="company-name" style="margin: 0 0 8px 0; font-size: 24px;"></h3>
                    <p id="company-details" style="margin: 0; opacity: 0.9; font-size: 14px;"></p>
                </div>

                <!-- 10-K Annual Reports Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìÑ 10-K Annual Reports (<span id="count-10k">0</span> available)
                    </summary>
                    <div id="list-10k" style="margin-top: 16px;"></div>
                </details>

                <!-- 10-Q Quarterly Reports Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìä 10-Q Quarterly Reports (<span id="count-10q">0</span> available)
                    </summary>
                    <div id="list-10q" style="margin-top: 16px;"></div>
                </details>

                <!-- Earnings Transcripts Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üéôÔ∏è Earnings Transcripts (<span id="count-transcripts">0</span> available)
                    </summary>
                    <div id="list-transcripts" style="margin-top: 16px;"></div>
                </details>

                <!-- Press Releases Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üì∞ Press Releases (<span id="count-press-releases">0</span> available)
                    </summary>
                    <div id="list-press-releases" style="margin-top: 16px;"></div>
                </details>

                <!-- Investor Presentations Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìé Investor Presentations (Drag & Drop PDF)
                    </summary>
                    <div style="margin-top: 16px;">
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                            Upload investor presentation PDFs for AI analysis using Gemini multimodal vision.
                        </p>
                        <div id="pdf-drop-zone"
                             style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 32px; text-align: center;
                                    background: #f9fafb; cursor: pointer; transition: all 0.2s;"
                             ondrop="handlePDFDrop(event)" ondragover="handlePDFDragOver(event)" ondragleave="handlePDFDragLeave(event)"
                             onclick="document.getElementById('pdf-file-input').click()">
                            <p style="font-size: 16px; color: #6b7280; margin: 0;">
                                üìé Drag and drop PDF here or click to browse
                            </p>
                            <p style="font-size: 12px; color: #9ca3af; margin: 8px 0 0 0;">
                                Supports earnings decks, investor days, analyst days, and conference presentations
                            </p>
                        </div>
                        <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;" onchange="handlePDFFileSelect(event)">

                        <!-- PDF Upload Form (hidden until file selected) -->
                        <div id="pdf-upload-form" style="display:none; margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 8px;">
                            <p style="margin: 0 0 16px 0; font-weight: 600;">Selected: <span id="pdf-filename"></span></p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Presentation Date</label>
                                    <input type="date" id="pdf-date" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type</label>
                                    <select id="pdf-type" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                        <option value="earnings">Earnings Deck</option>
                                        <option value="investor_day">Investor Day</option>
                                        <option value="analyst_day">Analyst Day</option>
                                        <option value="conference">Conference Presentation</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title</label>
                                <input type="text" id="pdf-title" placeholder="e.g., Q3 2024 Earnings Deck"
                                       style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                            </div>
                            <button onclick="uploadAndAnalyzePDF()"
                                    style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                                           color: white; border: none; padding: 12px 24px; border-radius: 8px;
                                           font-weight: 600; cursor: pointer;">
                                üöÄ Upload & Analyze with Gemini
                            </button>
                            <button onclick="cancelPDFUpload()"
                                    style="margin-left: 12px; background: #6b7280; color: white; border: none;
                                           padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Research Library Tab (renamed from View Profiles) -->
        <div id="research-library-tab" class="tab-content" style="display:none;">
            <h2>Research Library</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Browse, search, and manage all generated research documents.
            </p>

            <!-- Research Type Filter -->
            <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                <label style="font-weight: 600; color: #374151; margin: 0;">View:</label>
                <select id="research-type-filter" onchange="switchResearchType()"
                        style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; flex: 0 0 200px;">
                    <option value="10k">10-K Profiles</option>
                    <option value="10q">10-Q Profiles</option>
                    <option value="presentations">Investor Presentations</option>
                    <option value="transcripts">Earnings Transcripts</option>
                    <option value="press_releases">Press Releases</option>
                </select>

                <!-- Search Box -->
                <input
                    type="text"
                    id="profiles-search"
                    placeholder="üîç Search by ticker..."
                    oninput="filterProfiles()"
                    style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                    onfocus="this.style.borderColor='#1e40af'"
                    onblur="this.style.borderColor='#e5e7eb'"
                />
            </div>

            <div id="profiles-loading" style="text-align: center; padding: 40px;">
                <p style="color: #6b7280;">Loading...</p>
            </div>

            <div id="profiles-list" style="display:none;">
                <p id="profiles-count" style="margin-bottom: 16px; color: #6b7280; font-size: 14px;"></p>

                <div style="overflow-x: auto;">
                    <table id="research-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white;">
                            <tr id="table-headers">
                                <!-- Headers will be inserted dynamically -->
                            </tr>
                        </thead>
                        <tbody id="profiles-table-body">
                            <!-- Rows will be inserted dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="profiles-error" style="display:none; padding: 20px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px; margin-top: 20px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b;">Error loading research</p>
                <p id="profiles-error-message" style="margin: 8px 0 0 0; color: #991b1b; font-size: 14px;"></p>
            </div>
        </div>

        <!-- Profile Viewer Modal -->
        <div id="profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
            <div style="background: white; margin: 40px auto; max-width: 1000px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;">
                <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                    <h2 id="modal-title" style="margin: 0; color: #1e3a8a;">Company Profile</h2>
                    <button onclick="closeProfileModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                </div>

                <div id="modal-content" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                    <!-- Profile markdown will be rendered here -->
                </div>

                <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="downloadProfile()" style="background: #1e40af; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Download Markdown
                    </button>
                    <button onclick="closeProfileModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>StockDigest Research Tools | <a href="mailto:stockdigest.research@gmail.com" style="color: #1e40af;">Contact Support</a></p>
    </div>

    <script>
        const token = '{{ token }}';

        // =============================================================================
        // TAB SWITCHING
        // =============================================================================

        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // =============================================================================
        // =============================================================================
        // UNIFIED GENERATE RESEARCH TAB
        // =============================================================================

        let currentTickerData = null;
        let selectedPDFFile = null;

        async function loadTickerResearch() {
            const ticker = document.getElementById('unified-ticker').value.toUpperCase().trim();

            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            // Show loading, hide others
            document.getElementById('research-loading').style.display = 'block';
            document.getElementById('research-error').style.display = 'none';
            document.getElementById('research-sections').style.display = 'none';

            try {
                const response = await fetch(`/api/admin/ticker-research-status?ticker=${ticker}&token=${token}`);
                const data = await response.json();

                if (data.status === 'success') {
                    currentTickerData = data;
                    displayTickerResearch(data);
                } else {
                    document.getElementById('research-loading').style.display = 'none';
                    document.getElementById('research-error').style.display = 'block';
                    document.getElementById('research-error-message').textContent = data.message || 'Failed to load research options';
                }
            } catch (error) {
                document.getElementById('research-loading').style.display = 'none';
                document.getElementById('research-error').style.display = 'block';
                document.getElementById('research-error-message').textContent = error.message;
            }
        }

        function displayTickerResearch(data) {
            // Hide loading, show sections
            document.getElementById('research-loading').style.display = 'none';
            document.getElementById('research-sections').style.display = 'block';

            // Update company header
            document.getElementById('company-name').textContent = `${data.company_name} (${data.ticker})`;
            document.getElementById('company-details').textContent = `Industry: ${data.industry || 'N/A'}`;

            // Update counts
            document.getElementById('count-10k').textContent = data.available_10k.length;
            document.getElementById('count-10q').textContent = data.available_10q.length;
            document.getElementById('count-transcripts').textContent = data.available_transcripts.length;
            document.getElementById('count-press-releases').textContent = data.available_press_releases.length;

            // Populate lists
            populate10KList(data.available_10k, data.ticker);
            populate10QList(data.available_10q, data.ticker);
            populateTranscriptsList(data.available_transcripts, data.ticker);
            populatePressReleasesList(data.available_press_releases, data.ticker);
        }

        function populate10KList(items, ticker) {
            const container = document.getElementById('list-10k');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No 10-K filings available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.year}</strong> (Filed: ${item.filing_date})
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: '10k'})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: '10k'})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    const periodDisplay = item.period_end_date
                        ? `${item.year} (${formatShortDate(item.period_end_date)})`
                        : `${item.year}`;
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${periodDisplay}</strong>
                                ${item.filing_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.filing_date)}</span>` : ''}
                            </div>
                            <button onclick="generate10K('${ticker}', ${item.year}, '${item.filing_date}', '${item.period_end_date || ''}', '${item.sec_html_url}')"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        function populate10QList(items, ticker) {
            const container = document.getElementById('list-10q');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No 10-Q filings available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                const key = `${item.year}-Q${item.quarter}`;
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Q${item.quarter} ${item.year}</strong> (Filed: ${item.filing_date})
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: '10q', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: '10q', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    const periodDisplay = item.period_end_date
                        ? `Q${item.quarter} ${item.year} (${formatShortDate(item.period_end_date)})`
                        : `Q${item.quarter} ${item.year}`;
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${periodDisplay}</strong>
                                ${item.filing_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.filing_date)}</span>` : ''}
                            </div>
                            <button onclick="generate10Q('${ticker}', ${item.year}, ${item.quarter}, '${item.filing_date}', '${item.period_end_date || ''}', '${item.sec_html_url}')"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        function populateTranscriptsList(items, ticker) {
            const container = document.getElementById('list-transcripts');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No earnings transcripts available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.label}</strong>
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: 'transcripts', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: 'transcripts', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.label}</strong>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="model-select-${item.quarter}-${item.year}" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                    <option value="claude">Sonnet</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                                <button onclick="generateTranscript('${ticker}', ${item.quarter}, ${item.year})"
                                        style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    Generate
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function populatePressReleasesList(items, ticker) {
            const container = document.getElementById('list-press-releases');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No press releases available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.date}</strong>: ${item.title.substring(0, 60)}...
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: 'press_releases', report_date: '${item.date}'})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: 'press_releases', report_date: '${item.date}'})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.date}</strong>: ${item.title.substring(0, 60)}...
                            </div>
                            <button onclick="generatePressRelease('${ticker}', '${item.date}')"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        // Helper function to format date as MM/DD/YY
        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            const [year, month, day] = parts;
            return `${month}/${day}/${year.slice(2)}`;
        }

        // Generation functions (using existing backend endpoints)
        async function generate10K(ticker, year, filingDate, periodEndDate, secHtmlUrl) {
            // Use existing company profile generation endpoint
            alert(`Starting 10-K generation for ${ticker} FY${year}. This will take 5-10 minutes...`);

            try{
                const response = await fetch('/api/admin/generate-company-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        fiscal_year: year,
                        filing_date: filingDate,
                        period_end_date: periodEndDate,
                        sec_html_url: secHtmlUrl
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert(`10-K generation started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Failed to start generation: ${error.message}`);
            }
        }

        async function generate10Q(ticker, year, quarter, filingDate, periodEndDate, secHtmlUrl) {
            alert(`Starting 10-Q generation for ${ticker} Q${quarter} ${year}. This will take 5-10 minutes...`);

            try {
                const response = await fetch('/api/admin/generate-10q-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        fiscal_year: year,
                        fiscal_quarter: `Q${quarter}`,
                        filing_date: filingDate,
                        period_end_date: periodEndDate,
                        sec_html_url: secHtmlUrl
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert(`10-Q generation started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Failed to start generation: ${error.message}`);
            }
        }

        async function generateTranscript(ticker, quarter, year) {
            // Get selected model from dropdown
            const modelSelect = document.getElementById(`model-select-${quarter}-${year}`);
            const model = modelSelect ? modelSelect.value : 'claude';
            const modelName = model === 'gemini' ? 'Gemini 2.5 Flash' : 'Claude Sonnet 4.5';

            alert(`Generating transcript for ${ticker} Q${quarter} ${year} using ${modelName}...`);

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'transcript',
                        quarter: quarter,
                        year: year,
                        model: model
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    if (model === 'gemini') {
                        alert(`‚úÖ Transcript generated successfully with Gemini!\n\nGeneration time: ${result.generation_time_seconds}s\n\nView-only (no email sent for A/B testing).`);
                    } else {
                        alert('‚úÖ Transcript generated successfully! Check your email.');
                    }
                    loadTickerResearch(); // Reload to show updated status
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed: ${error.message}`);
            }
        }

        async function generatePressRelease(ticker, date) {
            alert(`Generating press release for ${ticker} on ${date}...`);

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'press_release',
                        pr_date: date
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('‚úÖ Press release summary generated! Check your email.');
                    loadTickerResearch(); // Reload
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed: ${error.message}`);
            }
        }

        // PDF drag & drop handlers
        function handlePDFDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#1e40af';
            e.target.style.background = '#eff6ff';
        }

        function handlePDFDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#e5e7eb';
            e.target.style.background = '#f9fafb';
        }

        function handlePDFDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#e5e7eb';
            e.target.style.background = '#f9fafb';

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                selectedPDFFile = files[0];
                showPDFUploadForm(files[0].name);
            } else {
                alert('Please drop a PDF file');
            }
        }

        function handlePDFFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                selectedPDFFile = files[0];
                showPDFUploadForm(files[0].name);
            } else {
                alert('Please select a PDF file');
            }
        }

        function showPDFUploadForm(filename) {
            document.getElementById('pdf-filename').textContent = filename;
            document.getElementById('pdf-upload-form').style.display = 'block';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pdf-date').value = today;
        }

        function cancelPDFUpload() {
            selectedPDFFile = null;
            document.getElementById('pdf-upload-form').style.display = 'none';
            document.getElementById('pdf-file-input').value = '';
        }

        async function uploadAndAnalyzePDF() {
            if (!selectedPDFFile || !currentTickerData) {
                alert('Please select a PDF and load ticker first');
                return;
            }

            const date = document.getElementById('pdf-date').value;
            const type = document.getElementById('pdf-type').value;
            const title = document.getElementById('pdf-title').value;

            if (!date || !title) {
                alert('Please fill in all fields');
                return;
            }

            // Read file as base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Content = e.target.result.split(',')[1]; // Remove data:application/pdf;base64, prefix

                alert(`Uploading and analyzing ${selectedPDFFile.name}. This will take 5-10 minutes...`);

                try {
                    const response = await fetch('/api/admin/generate-presentation', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            token: token,
                            ticker: currentTickerData.ticker,
                            presentation_date: date,
                            presentation_type: type,
                            presentation_title: title,
                            file_content: base64Content,
                            file_name: selectedPDFFile.name
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert(`‚úÖ Presentation analysis started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                        cancelPDFUpload(); // Clear form
                        loadTickerResearch(); // Reload to show updated status
                    } else {
                        alert(`‚ùå Error: ${result.message}`);
                    }
                } catch (error) {
                    alert(`‚ùå Failed: ${error.message}`);
                }
            };
            reader.readAsDataURL(selectedPDFFile);
        }

        // =============================================================================

        // VIEW PROFILES TAB - UNIFIED RESEARCH LIBRARY
        // =============================================================================

        let currentProfile = null;  // Store current document for download
        let currentResearchType = '10k';  // Current filter selection
        let allProfiles = [];  // Store all documents for filtering/sorting
        let currentSort = { column: 'ticker', direction: 'asc' };

        async function switchResearchType() {
            currentResearchType = document.getElementById('research-type-filter').value;
            await loadProfiles();
        }

        async function loadProfiles() {
            document.getElementById('profiles-loading').style.display = 'block';
            document.getElementById('profiles-list').style.display = 'none';
            document.getElementById('profiles-error').style.display = 'none';

            try {
                let endpoint, dataKey, params;

                switch (currentResearchType) {
                    case '10k':
                        endpoint = '/api/admin/company-profiles';
                        dataKey = 'profiles';
                        params = `token=${token}&filing_type=10-K`;
                        break;
                    case '10q':
                        endpoint = '/api/admin/company-profiles';
                        dataKey = 'profiles';
                        params = `token=${token}&filing_type=10-Q`;
                        break;
                    case 'presentations':
                        endpoint = '/api/admin/investor-presentations';
                        dataKey = 'presentations';
                        params = `token=${token}`;
                        break;
                    case 'transcripts':
                        endpoint = '/api/admin/transcripts';
                        dataKey = 'transcripts';
                        params = `token=${token}`;
                        break;
                    case 'press_releases':
                        endpoint = '/api/admin/press-releases';
                        dataKey = 'press_releases';
                        params = `token=${token}`;
                        break;
                }

                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayProfiles(data[dataKey] || []);
                } else {
                    document.getElementById('profiles-loading').style.display = 'none';
                    document.getElementById('profiles-error').style.display = 'block';
                    document.getElementById('profiles-error-message').textContent = data.message || 'Failed to load research';
                }
            } catch (error) {
                document.getElementById('profiles-loading').style.display = 'none';
                document.getElementById('profiles-error').style.display = 'block';
                document.getElementById('profiles-error-message').textContent = error.message;
            }
        }

        function displayProfiles(profiles) {
            allProfiles = profiles;
            document.getElementById('profiles-loading').style.display = 'none';
            document.getElementById('profiles-list').style.display = 'block';

            const typeLabels = {
                '10k': '10-K profile',
                '10q': '10-Q profile',
                'presentations': 'investor presentation',
                'transcripts': 'transcript',
                'press_releases': 'press release'
            };
            const typeLabel = typeLabels[currentResearchType] || 'document';
            document.getElementById('profiles-count').textContent = `Found ${profiles.length} ${typeLabel}${profiles.length !== 1 ? 's' : ''}`;

            // Build headers dynamically
            const thead = document.getElementById('table-headers');
            thead.innerHTML = getTableHeaders(currentResearchType);

            const tbody = document.getElementById('profiles-table-body');
            tbody.innerHTML = '';

            if (profiles.length === 0) {
                const emptyMessages = {
                    '10k': 'No 10-K profiles generated yet. Create one in the "Company Profiles" tab!',
                    '10q': 'No 10-Q profiles generated yet. (Infrastructure ready, not wired to UI)',
                    'presentations': 'No investor presentations analyzed yet.',
                    'transcripts': 'No earnings transcripts generated yet. Create one in the "Earnings Transcripts" tab!',
                    'press_releases': 'No press releases generated yet. Create one in the "Press Releases" tab!'
                };
                const colspan = (currentResearchType === '10k' || currentResearchType === '10q') ? '5' : '10';
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="padding: 40px; text-align: center; color: #6b7280;">${emptyMessages[currentResearchType]}</td></tr>`;
                return;
            }

            profiles.forEach(doc => {
                const row = document.createElement('tr');
                row.setAttribute('data-ticker', doc.ticker);
                row.style.borderBottom = '1px solid #e5e7eb';
                row.onmouseover = () => row.style.background = '#f9fafb';
                row.onmouseout = () => row.style.background = 'white';

                row.innerHTML = getTableRow(doc, currentResearchType);
                tbody.appendChild(row);
            });
        }

        function getTableHeaders(type) {
            const common = `
                <th onclick="sortTable('ticker')" style="padding: 8px; text-align: left; cursor: pointer; font-size: 13px;">
                    Ticker <span id="sort-ticker" style="font-size: 10px;">‚ñº</span>
                </th>
            `;

            switch (type) {
                case '10k':
                    return common + `
                        <th style="padding: 8px; text-align: left; font-size: 13px;">Company</th>
                        <th onclick="sortTable('fiscal_year')" style="padding: 8px; text-align: left; cursor: pointer; font-size: 13px;">FY</th>
                        <th onclick="sortTable('generated_at')" style="padding: 8px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 8px; text-align: center; font-size: 13px;">Tokens</th>
                        <th style="padding: 8px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case '10q':
                    return common + `
                        <th style="padding: 8px; text-align: left; font-size: 13px;">Company</th>
                        <th onclick="sortTable('fiscal_year')" style="padding: 8px; text-align: left; cursor: pointer; font-size: 13px;">Period</th>
                        <th onclick="sortTable('generated_at')" style="padding: 8px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 8px; text-align: center; font-size: 13px;">Tokens</th>
                        <th style="padding: 8px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'presentations':
                    return common + `
                        <th style="padding: 12px; text-align: left;">Company</th>
                        <th style="padding: 12px; text-align: left;">Title</th>
                        <th onclick="sortTable('presentation_date')" style="padding: 12px; text-align: left; cursor: pointer;">Date</th>
                        <th style="padding: 12px; text-align: center;">Type</th>
                        <th style="padding: 12px; text-align: center;">Pages</th>
                        <th onclick="sortTable('generated_at')" style="padding: 12px; text-align: left; cursor: pointer;">Analyzed</th>
                        <th style="padding: 12px; text-align: center;">Actions</th>
                    `;
                case 'transcripts':
                    return common + `
                        <th style="padding: 12px; text-align: left;">Quarter</th>
                        <th onclick="sortTable('report_date')" style="padding: 12px; text-align: left; cursor: pointer;">Report Date</th>
                        <th style="padding: 12px; text-align: center;">Words</th>
                        <th style="padding: 12px; text-align: center;">Model</th>
                        <th onclick="sortTable('generated_at')" style="padding: 12px; text-align: left; cursor: pointer;">Generated</th>
                        <th style="padding: 12px; text-align: center;">Actions</th>
                    `;
                case 'press_releases':
                    return common + `
                        <th onclick="sortTable('report_date')" style="padding: 12px; text-align: left; cursor: pointer;">Date</th>
                        <th style="padding: 12px; text-align: center;">Words</th>
                        <th style="padding: 12px; text-align: left;">AI Provider</th>
                        <th onclick="sortTable('generated_at')" style="padding: 12px; text-align: left; cursor: pointer;">Generated</th>
                        <th style="padding: 12px; text-align: center;">Actions</th>
                    `;
            }
        }

        function getTableRow(doc, type) {
            // Format date without time (just YYYY-MM-DD)
            const generatedDate = new Date(doc.generated_at).toLocaleDateString();

            switch (type) {
                case '10k':
                    const tokensIn10k = (doc.token_count_input || 0).toLocaleString();
                    const tokensOut10k = (doc.token_count_output || 0).toLocaleString();

                    return `
                        <td style="padding: 8px; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.ticker}</td>
                        <td style="padding: 8px; font-size: 12px;">${doc.company_name}</td>
                        <td style="padding: 8px; font-size: 12px;">${doc.fiscal_year}</td>
                        <td style="padding: 8px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 8px; text-align: center; color: #6b7280; font-size: 11px;">
                            ${tokensIn10k} / ${tokensOut10k}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case '10q':
                    const tokensIn10q = (doc.token_count_input || 0).toLocaleString();
                    const tokensOut10q = (doc.token_count_output || 0).toLocaleString();

                    // Build period display with period_end_date if available
                    let period;
                    if (doc.fiscal_quarter) {
                        // 10-Q
                        period = doc.period_end_date
                            ? `Q${doc.fiscal_quarter} ${doc.fiscal_year} (${formatShortDate(doc.period_end_date)})`
                            : `Q${doc.fiscal_quarter} ${doc.fiscal_year}`;
                    } else {
                        // 10-K
                        period = doc.period_end_date
                            ? `${doc.fiscal_year} (${formatShortDate(doc.period_end_date)})`
                            : doc.fiscal_year;
                    }

                    return `
                        <td style="padding: 8px; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.ticker}</td>
                        <td style="padding: 8px; font-size: 12px;">${doc.company_name}</td>
                        <td style="padding: 8px; font-size: 12px;">${period}</td>
                        <td style="padding: 8px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 8px; text-align: center; color: #6b7280; font-size: 11px;">
                            ${tokensIn10q} / ${tokensOut10q}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'presentations':
                    return `
                        <td style="padding: 12px; font-weight: 600; color: #1e40af;">${doc.ticker}</td>
                        <td style="padding: 12px;">${doc.company_name || 'N/A'}</td>
                        <td style="padding: 12px; font-size: 13px;">${doc.presentation_title || 'N/A'}</td>
                        <td style="padding: 12px; font-size: 13px;">${doc.presentation_date || 'N/A'}</td>
                        <td style="padding: 12px; text-align: center; font-size: 13px;">${doc.presentation_type || 'N/A'}</td>
                        <td style="padding: 12px; text-align: center;">${doc.page_count || 'N/A'}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${generatedDate}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'transcripts':
                    // Model badge with generation time
                    const modelBadge = doc.ai_provider === 'gemini'
                        ? `<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">üü© Gemini</span>`
                        : `<span style="background: #1e40af; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">üü¶ Sonnet</span>`;

                    const genTime = doc.processing_duration_seconds
                        ? `<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${doc.processing_duration_seconds}s</div>`
                        : '';

                    return `
                        <td style="padding: 12px; font-weight: 600; color: #1e40af;">${doc.ticker}</td>
                        <td style="padding: 12px;">${doc.quarter_label}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${doc.report_date || 'N/A'}</td>
                        <td style="padding: 12px; text-align: center;">${(doc.word_count || 0).toLocaleString()}</td>
                        <td style="padding: 12px; text-align: center;">${modelBadge}${genTime}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${generatedDate}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'press_releases':
                    return `
                        <td style="padding: 12px; font-weight: 600; color: #1e40af;">${doc.ticker}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${doc.report_date || 'N/A'}</td>
                        <td style="padding: 12px; text-align: center;">${(doc.word_count || 0).toLocaleString()}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${doc.ai_provider || 'N/A'}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${generatedDate}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
            }
        }

        function getActionButtons(doc, type) {
            const docId = JSON.stringify({
                ticker: doc.ticker,
                type: type,
                presentation_date: doc.presentation_date,
                quarter: doc.quarter,
                year: doc.year,
                report_date: doc.report_date,
                ai_provider: doc.ai_provider  // Include ai_provider for transcript disambiguation
            }).replace(/"/g, '&quot;');

            // Hide Email button for Gemini transcripts (view-only for A/B testing)
            const showEmailButton = !(type === 'transcripts' && doc.ai_provider === 'gemini');

            return `
                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                    <button onclick='viewDocument(${docId}); event.stopPropagation();'
                            title="View"
                            style="background: #1e40af; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üëÅÔ∏è
                    </button>
                    ${showEmailButton ? `
                    <button onclick='emailDocument(${docId}); event.stopPropagation();'
                            title="Email to Me"
                            style="background: #059669; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üìß
                    </button>
                    ` : ''}
                    <button onclick='deleteDocument(${docId}); event.stopPropagation();'
                            title="Delete"
                            style="background: #dc2626; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üóëÔ∏è
                    </button>
                </div>
            `;
        }

        async function viewDocument(docInfo) {
            try {
                // Find document in current list
                const doc = allProfiles.find(d => {
                    if (docInfo.type === '10k' || docInfo.type === '10q') {
                        return d.ticker === docInfo.ticker;
                    } else if (docInfo.type === 'presentations') {
                        return d.ticker === docInfo.ticker && d.presentation_date === docInfo.presentation_date;
                    } else if (docInfo.type === 'transcripts') {
                        // Include ai_provider to distinguish between Gemini and Sonnet versions
                        return d.ticker === docInfo.ticker && d.quarter === docInfo.quarter && d.year === docInfo.year && d.ai_provider === docInfo.ai_provider;
                    } else if (docInfo.type === 'press_releases') {
                        return d.ticker === docInfo.ticker && d.report_date === docInfo.report_date;
                    }
                });

                if (doc) {
                    currentProfile = doc;
                    currentProfile.type = docInfo.type; // Store type for download

                    // Set modal title
                    let title = '';
                    if (docInfo.type === '10k' || docInfo.type === '10q') {
                        title = `${doc.company_name} (${doc.ticker}) - FY${doc.fiscal_year}`;
                    } else if (docInfo.type === 'presentations') {
                        title = `${doc.company_name || doc.ticker} - ${doc.presentation_title || 'Presentation'} (${doc.presentation_date})`;
                    } else if (docInfo.type === 'transcripts') {
                        title = `${doc.ticker} Earnings Transcript - Q${doc.quarter} ${doc.year}`;
                    } else if (docInfo.type === 'press_releases') {
                        title = `${doc.ticker} Press Release - ${doc.report_date}`;
                    }
                    document.getElementById('modal-title').textContent = title;

                    // Get content
                    const content = doc.profile_markdown || doc.summary_text || 'No content available';
                    document.getElementById('modal-content').innerHTML = markdownToHtml(content);
                    document.getElementById('profile-modal').style.display = 'block';
                }
            } catch (error) {
                alert('Failed to load document: ' + error.message);
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
            currentProfile = null;
        }

        function downloadProfile() {
            if (!currentProfile) return;

            let filename, content;
            const type = currentProfile.type || currentResearchType;

            if (type === '10k' || type === '10q') {
                filename = `${currentProfile.ticker}_${type.toUpperCase()}_FY${currentProfile.fiscal_year}.md`;
                content = currentProfile.profile_markdown;
            } else if (type === 'presentations') {
                filename = `${currentProfile.ticker}_Presentation_${currentProfile.presentation_date}.md`;
                content = currentProfile.profile_markdown;
            } else if (type === 'transcripts') {
                filename = `${currentProfile.ticker}_Transcript_Q${currentProfile.quarter}_${currentProfile.year}.md`;
                content = currentProfile.summary_text;
            } else if (type === 'press_releases') {
                filename = `${currentProfile.ticker}_PressRelease_${currentProfile.report_date}.md`;
                content = currentProfile.summary_text;
            }

            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function filterProfiles() {
            const searchQuery = document.getElementById('profiles-search').value.toLowerCase();
            const rows = document.querySelectorAll('#profiles-table-body tr');

            let visibleCount = 0;
            rows.forEach(row => {
                const ticker = row.getAttribute('data-ticker') || '';

                if (ticker.toLowerCase().includes(searchQuery)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            const typeLabels = {
                '10k': '10-K profile',
                '10q': '10-Q profile',
                'presentations': 'presentation',
                'transcripts': 'transcript',
                'press_releases': 'press release'
            };
            const typeLabel = typeLabels[currentResearchType] || 'document';

            const countText = searchQuery ?
                `Showing ${visibleCount} of ${allProfiles.length} ${typeLabel}${allProfiles.length !== 1 ? 's' : ''}` :
                `Found ${allProfiles.length} ${typeLabel}${allProfiles.length !== 1 ? 's' : ''}`;
            document.getElementById('profiles-count').textContent = countText;
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update sort indicators
            document.querySelectorAll('[id^="sort-"]').forEach(el => {
                el.textContent = '‚óã';
            });
            const sortEl = document.getElementById(`sort-${column}`);
            if (sortEl) {
                sortEl.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            // Sort array
            const sorted = [...allProfiles].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (!aVal) return 1;
                if (!bVal) return -1;

                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ?
                        aVal.localeCompare(bVal) :
                        bVal.localeCompare(aVal);
                }

                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });

            displayProfiles(sorted);

            const searchQuery = document.getElementById('profiles-search').value;
            if (searchQuery) {
                filterProfiles();
            }
        }

        async function deleteDocument(docInfo) {
            if (!confirm(`Are you sure you want to delete this ${docInfo.type.replace('_', ' ')} for ${docInfo.ticker}?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                let endpoint, body;

                if (docInfo.type === '10k') {
                    endpoint = '/api/admin/delete-company-profile';
                    body = { token, ticker: docInfo.ticker };
                } else if (docInfo.type === 'presentations') {
                    endpoint = '/api/admin/delete-investor-presentation';
                    body = { token, ticker: docInfo.ticker, presentation_date: docInfo.presentation_date };
                } else if (docInfo.type === 'transcripts') {
                    endpoint = '/api/admin/delete-transcript';
                    body = { token, ticker: docInfo.ticker, quarter: docInfo.quarter, year: docInfo.year, report_type: 'transcript', ai_provider: docInfo.ai_provider };
                } else if (docInfo.type === 'press_releases') {
                    endpoint = '/api/admin/delete-transcript';
                    body = { token, ticker: docInfo.ticker, report_date: docInfo.report_date, report_type: 'press_release' };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                    loadProfiles();
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to delete: ${error.message}`);
            }
        }

        async function emailDocument(docInfo) {
            if (!confirm(`Send this ${docInfo.type.replace('_', ' ')} for ${docInfo.ticker} to your email?`)) {
                return;
            }

            try {
                let endpoint, body;

                if (docInfo.type === '10k') {
                    endpoint = '/api/admin/email-company-profile';
                    body = { token, ticker: docInfo.ticker };
                } else {
                    endpoint = '/api/admin/email-research';
                    body = {
                        token,
                        ticker: docInfo.ticker,
                        type: docInfo.type === 'transcripts' ? 'transcript' :
                              docInfo.type === 'press_releases' ? 'press_release' :
                              docInfo.type === 'presentations' ? 'presentation' : docInfo.type,
                        presentation_date: docInfo.presentation_date,
                        quarter: docInfo.quarter,
                        year: docInfo.year,
                        report_date: docInfo.report_date,
                        ai_provider: docInfo.ai_provider  // Include for transcript disambiguation
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to email: ${error.message}`);
            }
        }

        // Simple markdown to HTML converter
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Headers
            html = html.replace(/^# (.*$)/gim, '<h1 style="margin-top: 24px; margin-bottom: 12px; color: #1e3a8a; font-size: 28px;">$1</h1>');
            html = html.replace(/^## (.*$)/gim, '<h2 style="margin-top: 20px; margin-bottom: 10px; color: #1e40af; font-size: 22px;">$1</h2>');
            html = html.replace(/^### (.*$)/gim, '<h3 style="margin-top: 16px; margin-bottom: 8px; color: #2563eb; font-size: 18px;">$1</h3>');

            // Bold and italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Lists
            html = html.replace(/^\* (.*$)/gim, '<li style="margin-left: 20px; margin-bottom: 6px;">$1</li>');
            html = html.replace(/(<li.*<\/li>)/s, '<ul style="margin: 12px 0;">$1</ul>');

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p style="margin-bottom: 12px; line-height: 1.6;">');
            html = '<p style="margin-bottom: 12px; line-height: 1.6;">' + html + '</p>';

            return html;
        }

        // Enhanced switchTab to load profiles when View Profiles tab is opened
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName, event) {
            if (originalSwitchTab) {
                originalSwitchTab(tabName, event);
            } else {
                // Fallback if original doesn't exist
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabName + '-tab').style.display = 'block';
                if (event) event.target.classList.add('active');
            }

            // Load profiles when View Profiles tab is opened
            if (tabName === 'research-library') {
                loadProfiles();
            }
        };

        // Close modal on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProfileModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('profile-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });
    </script>
</body>
</html>
